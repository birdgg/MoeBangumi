# Rename Workflow

重命名服务负责将下载完成的媒体文件重命名为 Plex/Jellyfin 兼容的格式，支持 WebRip（普通 RSS 下载）和 BDRip（蓝光合集）两种模式。

## 架构设计

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           RenameService                                  │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                        process_all()                               │  │
│  │                    (定时任务入口)                                   │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                  │                                       │
│                                  ▼                                       │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                      process_task()                                │  │
│  │            (单任务处理，检测类型并分发)                              │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                    │                              │                      │
│         ┌─────────┴─────────┐          ┌─────────┴─────────┐            │
│         ▼                   ▼          ▼                   ▼            │
│  ┌─────────────┐    ┌─────────────┐                                     │
│  │ Standard    │    │   BDRip     │                                     │
│  │ Processor   │    │  Processor  │                                     │
│  │ (WebRip)    │    │ (蓝光合集)   │                                     │
│  └─────────────┘    └─────────────┘                                     │
│         │                   │                                            │
│         └─────────┬─────────┘                                            │
│                   ▼                                                      │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                    subtitles::rename_subtitles()                   │  │
│  │                      (字幕文件随视频重命名)                          │  │
│  └───────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
                                  │
              ┌───────────────────┼───────────────────┐
              ▼                   ▼                   ▼
       ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
       │DownloaderHdl│    │   pathgen   │    │Notification │
       │ (qBittorrent)│    │ (路径生成)  │    │  Service    │
       └─────────────┘    └─────────────┘    └─────────────┘
```

### 模块结构

```
core/domain/src/services/rename/
├── mod.rs           # 模块入口，定义 RenameError 和 RenameTaskResult
├── service.rs       # RenameService 主逻辑
├── standard.rs      # StandardProcessor (WebRip 处理)
├── bdrip.rs         # BDRipProcessor (蓝光合集处理)
├── subtitles.rs     # 字幕文件重命名
└── paths.rs         # 路径工具函数
```

## 核心流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          process_all()                                   │
│                       (Scheduler 定时调用)                               │
└─────────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ 1. get_pending_tasks()                                                   │
│    - 查询下载器中带 "rename" 标签的已完成任务                              │
│    - 通过 info_hash 匹配数据库中的 Torrent 记录                           │
│    - 获取关联的 BangumiWithSeries 信息                                    │
└─────────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ 2. process_task() - 并发处理 (concurrency=4)                             │
│    - 检查是否在临时目录，需要时移动到最终目录                               │
│    - 获取任务文件列表，筛选视频文件                                        │
│    - 检测是否为 BDRip（三重检测）                                         │
│    - 分发到对应的 Processor                                              │
└─────────────────────────────────────────────────────────────────────────┘
                                  │
                    ┌─────────────┴─────────────┐
                    ▼                           ▼
             ┌─────────────┐             ┌─────────────┐
             │  WebRip?    │             │   BDRip?    │
             └─────────────┘             └─────────────┘
                    │                           │
                    ▼                           ▼
┌───────────────────────────────┐ ┌───────────────────────────────────────┐
│ StandardProcessor::process()   │ │ BDRipProcessor::process()              │
│ - 解析文件名获取集数            │ │ - 解析目录结构获取季数/集数             │
│ - 应用 episode_offset          │ │ - 分类：Episode / Special / NonVideo  │
│ - 生成 Plex 格式文件名          │ │ - 多季重命名到不同目录                  │
│ - 重命名视频和字幕              │ │ - 特典重命名到 Specials 目录            │
└───────────────────────────────┘ └───────────────────────────────────────┘
                    │                           │
                    └─────────────┬─────────────┘
                                  ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ 3. finalize_task()                                                       │
│    - 移除 "rename" 标签                                                  │
│    - 返回 RenameTaskResult                                               │
└─────────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ 4. 后处理                                                                │
│    - 按 bangumi_id 分组结果                                              │
│    - 更新 current_episode（仅当大于当前值）                               │
│    - 检查是否全部下载完成，自动禁用 RSS                                    │
│    - 发送通知（支持带海报图片）                                           │
└─────────────────────────────────────────────────────────────────────────┘
```

## 临时目录机制

为防止下载过程中文件被 Plex/Jellyfin 扫描到不完整状态，下载器使用临时目录：

```
下载阶段:
┌────────────────────────────────────────────────────────────────────────┐
│  {base_path}/.downloading/{info_hash}/                                  │
│      └── [SubGroup] Anime - 01.mkv  (下载中)                            │
└────────────────────────────────────────────────────────────────────────┘
                                  │
                          下载完成后
                                  │
                                  ▼
重命名阶段:
┌────────────────────────────────────────────────────────────────────────┐
│  1. RenameService 检测到 save_path 包含 ".downloading"                  │
│  2. 动态生成最终目录路径                                                 │
│  3. 调用 downloader.set_location() 移动任务                             │
│  4. 执行文件重命名                                                       │
└────────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
最终位置:
┌────────────────────────────────────────────────────────────────────────┐
│  {base_path}/葬送的芙莉莲 (2023) {tmdb-209867}/Season 01/               │
│      └── 葬送的芙莉莲 - s01e01.mkv                                      │
└────────────────────────────────────────────────────────────────────────┘
```

### 路径生成规则

最终目录路径动态生成，不存储在数据库：

```
目录格式: {base_path}/{series_title} ({year}) {tmdb-ID}/Season {season:02}/

示例:
/downloads/葬送的芙莉莲 (2023) {tmdb-209867}/Season 01/
/downloads/Re Zero 从零开始的异世界生活 (2016) {tmdb-12345}/Season 02/
```

## BDRip 检测

使用三重检测机制判断是否为 BDRip：

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          is_bdrip() 检测                                 │
└─────────────────────────────────────────────────────────────────────────┘
                                  │
         ┌────────────────────────┼────────────────────────┐
         ▼                        ▼                        ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────────┐
│ 1. source_type  │    │ 2. 标题检测      │    │ 3. 目录结构检测          │
│   == BDRip      │    │ 包含 "bdrip"    │    │ 包含特征目录             │
│  (用户手动标记)  │    │ (大小写不敏感)   │    │                         │
└─────────────────┘    └─────────────────┘    └─────────────────────────┘
         │                        │                        │
         │                        │           ┌────────────┴────────────┐
         │                        │           │  特征目录:               │
         │                        │           │  /SPs/ /SP/ /Specials/  │
         │                        │           │  /CDs/ /CD/ /Scans/     │
         │                        │           └─────────────────────────┘
         │                        │                        │
         └────────────────────────┴────────────────────────┘
                                  │
                         任一条件满足
                                  │
                                  ▼
                          ┌─────────────┐
                          │   BDRip     │
                          └─────────────┘
```

## BDRip 处理流程

BDRipProcessor 使用 `parser::BDRipParser` 解析文件路径：

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     BDRipParser::parse(file_path)                        │
└─────────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ 1. 检查非视频目录 (CDs, Scans, Fonts, Music, OST)                        │
│    → 返回 BDRipContentType::NonVideo，跳过处理                           │
└─────────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ 2. 检查特典目录 (SPs, Specials, OVA, NCOP, NCED, PV, Extras)             │
│    → 设置 is_special = true                                              │
└─────────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ 3. 从目录名解析季数                                                       │
│    - "2nd Season" → 2                                                    │
│    - "Season 2"   → 2                                                    │
│    - "第二季"     → 2                                                    │
│    - "第十一季"   → 11                                                   │
└─────────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ 4. 从文件名解析集数                                                       │
│    Episode: [26] → 26                                                    │
│    Special: [SP01] / OVA2 / 特典01 → 1/2/1                               │
└─────────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
                    ┌─────────────┴─────────────┐
                    ▼                           ▼
             ┌─────────────┐             ┌─────────────┐
             │  Episode    │             │  Special    │
             └─────────────┘             └─────────────┘
                    │                           │
                    ▼                           ▼
┌───────────────────────────────┐ ┌───────────────────────────────────────┐
│ 重命名到季度目录                │ │ 重命名到 Specials 目录                  │
│ .../Season 02/                 │ │ .../Specials/                          │
│ Title - s02e26.mkv             │ │ Title - s00e01.mkv                     │
└───────────────────────────────┘ └───────────────────────────────────────┘
```

### 多季 BDRip 支持

对于包含多季的 BDRip 合集，通过 `torrent_bangumi` 关联表支持多个 bangumi。

**前置条件：所有关联的 bangumi 必须属于同一个 series**

```
Series: Re:Zero 从零开始的异世界生活 (series_id=100, tmdb_id=12345)
    │
    ├── Bangumi: Season 1 (bangumi_id=1, series_id=100, season=1, year=2016)
    ├── Bangumi: Season 2 (bangumi_id=2, series_id=100, season=2, year=2020)
    └── Bangumi: Season 3 (bangumi_id=3, series_id=100, season=3, year=2024)

Torrent: [VCB-Studio] Re Zero Complete
    │
    ├── torrent_bangumi: (torrent_id, bangumi_id=1)
    ├── torrent_bangumi: (torrent_id, bangumi_id=2)
    └── torrent_bangumi: (torrent_id, bangumi_id=3)
```

**为什么需要同一个 series_id？**

路径生成依赖 series 表提供统一的目录结构：

```
目录结构:
{base_path}/{series.title_chinese} ({bangumi.year}) {tmdb-{series.tmdb_id}}/Season {bangumi.season}/

所有季度共用:
  - series.title_chinese  → 目录名
  - series.tmdb_id        → 刮削器识别

每季不同:
  - bangumi.year          → 年份（可能不同）
  - bangumi.season        → 季数
```

**解析文件时根据季数匹配对应 bangumi：**

```
/1st Season/[01].mkv  →  匹配 bangumi.season=1  →  使用 bangumi_id=1
/2nd Season/[26].mkv  →  匹配 bangumi.season=2  →  使用 bangumi_id=2
/3rd Season/[51].mkv  →  匹配 bangumi.season=3  →  使用 bangumi_id=3

最终路径:
/downloads/Re Zero 从零开始的异世界生活 (2016) {tmdb-12345}/Season 01/Re Zero... - s01e01.mkv
/downloads/Re Zero 从零开始的异世界生活 (2020) {tmdb-12345}/Season 02/Re Zero... - s02e26.mkv
/downloads/Re Zero 从零开始的异世界生活 (2024) {tmdb-12345}/Season 03/Re Zero... - s03e51.mkv
```

**匹配失败时的回退策略：**

```
当解析到的 season 在关联的 bangumi 中找不到匹配时：
  → 使用 all_bangumi.first()（按 season 排序后的第一个）
  → 通常是 Season 1
```

## 文件名生成规则

使用 `pathgen` 库生成 Plex/Jellyfin 兼容的文件名：

### 目录格式

```
{base_path}/{series_title} ({year}) {tmdb-ID}/Season {season:02}/

规则:
- series_title: 使用 Series 表的 title_chinese（系列级别）
- year: 使用 Bangumi 表的 year（每季可能不同）
- tmdb_id: 使用 Series 表的 tmdb_id（可选，用于刮削器识别）
- season: 两位数格式，如 01, 02

示例:
/downloads/葬送的芙莉莲 (2023) {tmdb-209867}/Season 01/
/downloads/葬送的芙莉莲 (2023) {tmdb-209867}/Specials/
```

### 文件名格式

```
{title} - s{season:02}e{episode:02}.{ext}

规则:
- title: 使用 Bangumi 表的 title_chinese（季度级别）
- season: 两位数格式
- episode: 两位数格式，应用 episode_offset 后的值
- ext: 保留原始扩展名

示例:
葬送的芙莉莲 - s01e01.mkv
葬送的芙莉莲 - s01e28.mkv
葬送的芙莉莲 - s00e01.mkv  (特典)

电影格式:
葬送的芙莉莲.mkv  (platform=movie 时不加季集号)
```

### 集数偏移 (episode_offset)

RSS 中的集数可能是绝对集数，需要转换为季度相对集数：

```
场景: 第二季第1集在 RSS 中显示为第13集
配置: bangumi.episode_offset = 12

转换:
  RSS 集数 13 - offset 12 = 季度集数 1
  文件名: Title - s02e01.mkv

注意: 仅当 episode > offset 时才应用偏移
```

## 字幕处理

字幕文件与视频文件一起重命名，保留语言标签：

```
原始文件:
  [SubGroup] Anime - 01.mkv
  [SubGroup] Anime - 01.ass
  [SubGroup] Anime - 01.zh-CN.ass
  [SubGroup] Anime - 01.简体中文.srt

重命名后:
  Anime - s01e01.mkv
  Anime - s01e01.ass
  Anime - s01e01.zh-CN.ass
  Anime - s01e01.简体中文.srt
```

支持的字幕格式：`.ass`, `.srt`, `.ssa`, `.sub`, `.vtt`

## 错误处理与重试

### 错误类型

```
RenameError:
├── Database(sqlx::Error)       # 数据库错误
├── Downloader(DownloaderError) # 下载器通信错误
├── TorrentNotFound(String)     # info_hash 未找到对应记录
├── BangumiNotFound(i64)        # bangumi_id 不存在
└── Io(std::io::Error)          # 文件操作错误
```

### 重试机制

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          错误处理策略                                    │
└─────────────────────────────────────────────────────────────────────────┘

1. 任务级别错误:
   - 单个任务失败不影响其他任务
   - 失败任务保留 "rename" 标签，下次调度时重试
   - 错误信息记录到日志

2. 临时目录移动失败:
   - 返回错误，跳过此任务
   - 下次调度时重试移动

3. 文件重命名失败:
   - 记录警告日志
   - 继续处理其他文件
   - 不移除 "rename" 标签

4. 成功处理:
   - 移除 "rename" 标签
   - 任务不会再次处理
```

### 并发控制

```
默认并发数: 4

配置方式:
  RenameService::new(...).with_concurrency(8)

使用 buffer_unordered 限制同时处理的任务数，避免:
- 下载器 API 过载
- 数据库连接耗尽
- 磁盘 I/O 过高
```

## 通知机制

重命名完成后发送通知：

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          通知流程                                        │
└─────────────────────────────────────────────────────────────────────────┘

1. 按 bangumi_id 分组结果
2. 合并同一番剧的多个集数
3. 格式化通知标题: "{title} 第{episodes}话"
   - 连续集数: "第1-3话"
   - 非连续:   "第1, 3, 5话"

4. 发送通知:
   - 有海报: notify_download_with_photo()
   - 无海报: notify_download()

5. 海报缓存:
   - 使用 poster_path 作为 Telegram file_id 缓存 key
   - 避免重复上传相同图片
```

## RSS 自动禁用

当番剧全部下载完成时，自动禁用相关 RSS 订阅：

```
条件:
  total_episodes > 0 AND current_episode >= total_episodes

操作:
  RssRepository::disable_by_bangumi_id(bangumi_id)

日志:
  "Auto-disabled {} RSS subscription(s) for completed bangumi '{}'"
```